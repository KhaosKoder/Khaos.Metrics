# Testing & BenchmarksThis guide covers how to validate changes before opening a PR.## Unit tests- Run the full suite:  ```powershell  dotnet test  ```- The project currently ships with 17 focused xUnit tests covering:  - Metrics windows (rollover, aggregation, overflow, sampling, concurrency, tags).  - Event dispatch paths (inline vs. background queue, drop accounting).  - CPU measurement toggle behavior.  - Time mode handling via custom clocks.  - Dependency injection wiring and snapshot composition (new tests in `DependencyInjectionTests` and `SnapshotProviderTests`).- Use the helper types in `tests/.../Infrastructure` (`TestClock`, `FakeDataSource`, `TestEventSink`) to add deterministic scenarios.## CoverageWe rely on Coverlet to capture line coverage. Example command:```powershelldotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover```Aim for 80%+ in `Khaos.Metrics.Core`, especially for non-trivial helpers such as `MonitoringSnapshotProvider`, `OperationTags`, `MonitoringServiceCollectionExtensions`, and `EventDispatcher`.## BenchmarksThe `benchmarks/Khaos.Metrics.Benchmarks` project uses BenchmarkDotNet to track instrumentation overhead. Typical runs:```powershelldotnet run -c Release --project benchmarks/Khaos.Metrics.Benchmarks```Benchmarks currently include:1. **Baseline scopes** â€“ inline dispatch, CPU sampling off.2. **Background queue scopes** â€“ validates enqueue cost with a no-op sink.3. **Sampled scopes** â€“ demonstrates the effect of higher `SamplingRate` values.4. **CPU sampler impact** â€“ compares `EnableCpuMeasurement` true/false.Update benchmark descriptions whenever you add a new scenario so downstream consumers know what numbers represent.## Troubleshooting tips- If a test stalls, ensure all `MonitoringEngine` instances are disposed (use `using` blocks in tests).- Background-queue tests rely on `ManualResetEventSlim`. Keep timeouts generous to avoid flakiness on CI.- Use `TestClock.Advance` whenever you need deterministic timestamp progression.
