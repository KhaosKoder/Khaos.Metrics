using System;using System.Linq;using Khaos.Metrics.Core.Tests.Infrastructure;namespace Khaos.Metrics.Core.Tests;public class SnapshotProviderTests{    [Fact]    public void GetSnapshot_ComposesOperationSnapshots()    {        var clock = new TestClock(DateTimeOffset.Parse("2025-01-01T00:00:00Z"));        var options = new MonitoringOptions        {            HotBucketCount = 2,            HotBucketSeconds = 1,            WarmBucketCount = 3,            WarmBucketMinutes = 1,            ColdBucketCount = 2,            ColdBucketHours = 1        };        var hotBuckets = new[]        {            CreateBucket(2, TimeSpan.FromMilliseconds(2), TimeSpan.FromMilliseconds(3)),            CreateBucket(3, TimeSpan.FromMilliseconds(4), TimeSpan.FromMilliseconds(5))        };        var warmBuckets = new[]        {            CreateBucket(1, TimeSpan.FromMilliseconds(4), TimeSpan.FromMilliseconds(4)),            CreateBucket(2, TimeSpan.FromMilliseconds(2), TimeSpan.FromMilliseconds(3)),            CreateBucket(0, TimeSpan.Zero, TimeSpan.Zero)        };        var coldBuckets = new[]        {            CreateBucket(1, TimeSpan.FromMilliseconds(8), TimeSpan.FromMilliseconds(9)),            CreateBucket(1, TimeSpan.FromMilliseconds(6), TimeSpan.FromMilliseconds(7))        };        var data = new[]        {            CreateSnapshotData("alpha", 5, 1, hotBuckets, warmBuckets, coldBuckets)        };        var provider = new MonitoringSnapshotProvider(new FakeDataSource(options, data), clock);        var snapshot = provider.GetSnapshot();        Assert.Equal(clock.Now, snapshot.GeneratedAt);        var operation = Assert.Single(snapshot.Operations);        Assert.Equal("alpha", operation.Name);        Assert.Equal(5, operation.TotalCount);        Assert.Equal(1, operation.TotalFailures);        var totalHotTicks = hotBuckets.Sum(b => b.TotalTicks);        var totalHotCount = hotBuckets.Sum(b => b.Count);        var expectedAverage = StopwatchTime.ToTimeSpan(totalHotTicks / (double)totalHotCount);        var expectedMax = StopwatchTime.ToTimeSpan(hotBuckets.Max(b => b.MaxTicks));        Assert.Equal(2.5, operation.CurrentRatePerSecond);        Assert.Equal(expectedAverage, operation.CurrentAverageDuration);        Assert.Equal(expectedMax, operation.CurrentMaxDuration);        Assert.Equal(3, operation.PerMinute.Count);        Assert.Equal(clock.Now - TimeSpan.FromMinutes(2), operation.PerMinute[0].Timestamp);        Assert.Equal(warmBuckets[0].Count, operation.PerMinute[0].Count);        Assert.Equal(2, operation.PerHour.Count);        Assert.Equal(clock.Now - TimeSpan.FromHours(1), operation.PerHour[0].Timestamp);    }    [Fact]    public void GetOperationSnapshot_FiltersByName()    {        var clock = new TestClock(DateTimeOffset.Parse("2025-01-02T00:00:00Z"));        var options = new MonitoringOptions        {            HotBucketCount = 1,            HotBucketSeconds = 1,            WarmBucketCount = 1,            WarmBucketMinutes = 1,            ColdBucketCount = 1,            ColdBucketHours = 1        };        var alpha = CreateSnapshotData(            "alpha",            10,            0,            new[] { CreateBucket(1, TimeSpan.FromMilliseconds(1), TimeSpan.FromMilliseconds(1)) },            new[] { CreateBucket(1, TimeSpan.FromMilliseconds(1), TimeSpan.FromMilliseconds(1)) },            new[] { CreateBucket(1, TimeSpan.FromMilliseconds(1), TimeSpan.FromMilliseconds(1)) });        var beta = CreateSnapshotData(            "beta",            20,            2,            new[] { CreateBucket(2, TimeSpan.FromMilliseconds(2), TimeSpan.FromMilliseconds(3)) },            new[] { CreateBucket(2, TimeSpan.FromMilliseconds(2), TimeSpan.FromMilliseconds(3)) },            new[] { CreateBucket(2, TimeSpan.FromMilliseconds(2), TimeSpan.FromMilliseconds(3)) });        var provider = new MonitoringSnapshotProvider(new FakeDataSource(options, new[] { alpha, beta }), clock);        Assert.Null(provider.GetOperationSnapshot(string.Empty));        Assert.Null(provider.GetOperationSnapshot("missing"));        var snapshot = provider.GetOperationSnapshot("beta");        Assert.NotNull(snapshot);        Assert.Equal("beta", snapshot!.Name);        Assert.Equal(beta.TotalCount, snapshot.TotalCount);    }    private static OperationMetricsSnapshotData CreateSnapshotData(        string name,        long totalCount,        long totalFailures,        MetricsBucket[] hot,        MetricsBucket[] warm,        MetricsBucket[] cold)        => new OperationMetricsSnapshotData(            name,            totalCount,            totalFailures,            0,            0,            hot,            hot.Length - 1,            warm,            warm.Length - 1,            cold,            cold.Length - 1);    private static MetricsBucket CreateBucket(long count, TimeSpan averageDuration, TimeSpan maxDuration)    {        var totalTicks = count > 0 ? TestClock.ToStopwatchTicks(averageDuration) * count : 0;        var maxTicks = count > 0 ? TestClock.ToStopwatchTicks(maxDuration) : 0;        return new MetricsBucket        {            Count = count,            TotalTicks = totalTicks,            MaxTicks = maxTicks,            MinTicks = totalTicks > 0 ? TestClock.ToStopwatchTicks(averageDuration) : long.MaxValue        };    }}
