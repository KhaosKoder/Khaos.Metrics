using System;using System.Linq;using Khaos.Metrics.Core.Tests.Infrastructure;namespace Khaos.Metrics.Core.Tests;public class MetricsTests{    [Fact]    public void BucketsResetAfterAdvancing()    {        var options = new MonitoringOptions        {            HotBucketCount = 2,            HotBucketSeconds = 1,            WarmBucketCount = 1,            ColdBucketCount = 1,            EventDispatchMode = EventDispatchMode.Inline        };        using var engine = CreateEngine(options);        var clock = new TestClock(DateTimeOffset.UtcNow);        var monitor = new OperationMonitor(engine, clock, new TestOptionsMonitor(options));        var snapshotProvider = new MonitoringSnapshotProvider(engine, clock);        var scope = monitor.Begin("op");        clock.Advance(TimeSpan.FromMilliseconds(10));        scope.Dispose();        var first = snapshotProvider.GetSnapshot().Operations.Single();        Assert.True(first.CurrentRatePerSecond > 0);        var metrics = engine.TryGetMetrics("op")!;        metrics.AdvanceHot();        metrics.AdvanceHot();        var second = snapshotProvider.GetSnapshot().Operations.Single();        Assert.Equal(0, second.CurrentRatePerSecond);        Assert.Equal(TimeSpan.Zero, second.CurrentAverageDuration);    }    [Fact]    public void SnapshotReflectsTotals()    {        var options = new MonitoringOptions        {            HotBucketCount = 3,            HotBucketSeconds = 1,            WarmBucketCount = 2,            ColdBucketCount = 2,            EventDispatchMode = EventDispatchMode.Inline        };        using var engine = CreateEngine(options);        var clock = new TestClock(DateTimeOffset.UtcNow);        var monitor = new OperationMonitor(engine, clock, new TestOptionsMonitor(options));        var provider = new MonitoringSnapshotProvider(engine, clock);        for (var i = 0; i < 4; i++)        {            var scope = monitor.Begin("calc");            clock.Advance(TimeSpan.FromMilliseconds(5 + i));            if (i % 2 == 0)            {                scope.MarkFailed();            }            scope.Dispose();        }        var snapshot = provider.GetSnapshot().Operations.Single();        Assert.Equal(4, snapshot.TotalCount);        Assert.Equal(2, snapshot.TotalFailures);        Assert.True(snapshot.CurrentAverageDuration > TimeSpan.Zero);        Assert.Equal(2, snapshot.PerMinute.Count);        Assert.Equal(2, snapshot.PerHour.Count);    }    private static MonitoringEngine CreateEngine(MonitoringOptions options)        => new MonitoringEngine(new TestOptionsMonitor(options), Array.Empty<IOperationEventSink>());}
